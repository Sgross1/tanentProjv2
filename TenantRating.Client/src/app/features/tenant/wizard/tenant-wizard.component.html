<div class="wizard-page-container">
  <div class="wizard-layout centered-layout">
    <!-- Form Side (Now Centered container) -->
    <div class="form-side">
      <h1 class="page-title">KaLiScore - פניה חדשה</h1>

      <div class="wizard-card">
        <!-- Result Step (Full Width) -->
        <div class="step-content result fade-in" *ngIf="currentStep === 4">
          <h2>הדירוג שלך מוכן!</h2>

          <div class="score-display">
            <div class="score-circle">
              <span class="score-value">{{
                finalScore | number: "1.0-1"
              }}</span>
              <span class="score-label">ציון אמינות</span>
            </div>
          </div>

          <p class="score-desc">
            עבור שכ"ד {{ requestData.desiredRent | number }} ₪
          </p>

          <div class="distribution-graph-container">
            <h3>איפה אתה ביחס לאחרים?</h3>
            <div class="graph-wrapper">
              <div class="y-axis-label">כמות אנשים</div>
              <div class="distribution-graph">
                <div class="bar-wrapper" *ngFor="let bar of distributionBars">
                  <div class="label-you" *ngIf="bar.isUser">אתה כאן!</div>
                  <div
                    class="bar"
                    [style.height.%]="bar.height"
                    [class.highlight]="bar.isUser"
                  ></div>
                </div>
              </div>
            </div>

            <div class="x-axis">
              <span class="range-val">0</span>
              <span class="x-label-text">ציון אמינות</span>
              <span class="range-val">100</span>
            </div>
            <p class="graph-note">
              הציון שלך גבוה מ-{{ userPercentile }}% מהמחפשים בתקציב זה.
            </p>
          </div>

          <div class="slider-box">
            <h4>רוצה לשפר ל-{{ sliderValue }}?</h4>
            <input
              type="range"
              min="10"
              max="100"
              step="1"
              [(ngModel)]="sliderValue"
              (input)="updateRentCalculation()"
            />
            <p>
              תקציב מומלץ: <strong>{{ calculatedRent | number }} ₪</strong>
            </p>
          </div>

          <div class="notification-actions">
            <button class="btn-outline" (click)="sendSms()">📱 SMS</button>
            <button class="btn-outline" (click)="sendEmail()">📧 מייל</button>
          </div>

          <div class="actions">
            <button class="btn-primary full-width" (click)="finish()">
              סיום וחזרה
            </button>
          </div>
        </div>

        <!-- Wizard Steps (Columns Layout) -->
        <div class="wizard-columns" *ngIf="currentStep !== 4">
          <!-- Wheel / Visual Column -->
          <div class="wheel-column">
            <!-- Wheel for Steps 1, 2 -->
            <div class="wheel-wrapper-inline" *ngIf="currentStep !== 3">
              <app-wheel
                [percent]="calculateProgress()"
                [statusText]="getProgressText()"
                size="small"
              >
              </app-wheel>
            </div>

            <!-- Cube for Step 3 (Processing) -->
            <div class="cube-wrapper-inline" *ngIf="currentStep === 3">
              <app-three-cube mode="loading"></app-three-cube>
            </div>
          </div>

          <!-- Content Column -->
          <div class="content-column">
            <!-- Step 1: Details -->
            <div class="step-content fade-in" *ngIf="currentStep === 1">
              <h2>פרטים בסיסיים</h2>
              <p>בוא נתחיל עם הפרטים על הדירה שאתה מחפש.</p>

              <div class="form-group">
                <label>תעודת זהות</label>
                <input
                  type="text"
                  [(ngModel)]="requestData.idNumbers[0]"
                  (input)="onIdNumberInput()"
                  (blur)="onIdNumberInput()"
                  placeholder="מספר תעודת זהות תקין (9 ספרות)"
                />
                <div class="error-message" *ngIf="idNumberError">
                  {{ idNumberError }}
                </div>
              </div>

              <div class="form-group relative">
                <label>יישובים מבוקשים</label>
                <div class="city-chips">
                  <div class="chip" *ngFor="let city of requestData.cities">
                    {{ city }}
                    <span class="remove" (click)="removeCity(city)">×</span>
                  </div>
                </div>
                <input
                  type="text"
                  [(ngModel)]="citySearchQuery"
                  (input)="searchCities()"
                  placeholder="הקלד שם ישוב..."
                  [disabled]="requestData.cities.length >= 5"
                />
                <div
                  class="autocomplete-dropdown"
                  *ngIf="filteredCities.length > 0"
                >
                  <div
                    class="suggestion"
                    *ngFor="let city of filteredCities"
                    (click)="addCity(city)"
                  >
                    {{ city }}
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label>שכר דירה רצוי (₪)</label>
                <input
                  type="number"
                  [(ngModel)]="requestData.desiredRent"
                  placeholder="לדוגמה: 6000"
                />
              </div>

              <div class="actions">
                <button class="btn-secondary" routerLink="/tenant/dashboard">
                  ביטול
                </button>
                <button
                  class="btn-primary"
                  (click)="nextStep()"
                  [disabled]="
                    requestData.cities.length === 0 ||
                    !requestData.desiredRent ||
                    !requestData.idNumbers[0]
                  "
                >
                  המשך
                </button>
              </div>
            </div>

            <!-- Step 2: Upload -->
            <div class="step-content fade-in" *ngIf="currentStep === 2">
              <h2>העלאת מסמכים</h2>
              <p>
                {{
                  spouseFilesRequested
                    ? "העלה 3 תלושים של בן/בת הזוג"
                    : 'העלה 3 תלושי שכר אחרונים
                                ותדפיס עו"ש.'
                }}
              </p>

              <div class="spouse-promo" *ngIf="askSpouse">
                <h3>🎉 כל הכבוד!</h3>
                <p>
                  העלית 3 מסמכים. רוצה להעלות גם את של בן/בת הזוג לשיפור הדירוג?
                </p>
                <div class="promo-actions">
                  <button
                    class="btn-primary small"
                    (click)="acceptSpouseUpload()"
                  >
                    כן, הוסף
                  </button>
                  <button
                    class="btn-secondary small"
                    (click)="declineSpouseUpload()"
                  >
                    לא, תודה
                  </button>
                </div>
              </div>

              <div class="upload-zone" (click)="fileInput.click()">
                <input
                  #fileInput
                  type="file"
                  multiple
                  style="display: none"
                  (change)="onFileSelected($event)"
                />
                <div class="icon">📂</div>
                <p>לחץ לבחירת קבצים</p>
                <div class="files-preview">
                  <div
                    class="file-item"
                    *ngFor="let file of uploadedFiles; let i = index"
                  >
                    {{ file.name }}
                    <span
                      class="remove"
                      (click)="removeFile(i); $event.stopPropagation()"
                      >✕</span
                    >
                  </div>
                </div>
              </div>

              <div class="actions">
                <button class="btn-secondary" (click)="prevStep()">חזור</button>
                <button
                  class="btn-primary"
                  (click)="nextStep()"
                  [disabled]="uploadedFiles.length === 0"
                >
                  נתח מסמכים
                </button>
              </div>
            </div>

            <!-- Step 3: Processing -->
            <div class="step-content processing" *ngIf="currentStep === 3">
              <h2>מנתח נתונים...</h2>
              <p>ה-AI שלנו סורק את המסמכים ואת ההיסטוריה הפיננסית.</p>

              <div class="scanner-animation">
                <div class="doc-icon">📄</div>
                <div class="scan-line"></div>
              </div>

              <p class="status-blink">מבצע הצלבת נתונים...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
